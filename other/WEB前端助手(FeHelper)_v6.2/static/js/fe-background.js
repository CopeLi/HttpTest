var BgPageInstance=(function(){var q={css:false,js:false,html:true,allDone:false};var b=null;var h=function(){b=window.setInterval(function(){if(q.css&&q.js&&q.html){q.allDone=true;window.clearInterval(b)}},100)};var g=function(s){if(q.allDone){chrome.tabs.sendMessage(s.id,{type:MSG_TYPE.BROWSER_CLICKED,event:MSG_TYPE.FCP_HELPER_DETECT})}else{baidu.feNotification.notifyText({message:"正在准备数据，请稍等..."})}};var n=function(s){chrome.tabs.sendMessage(s.id,{type:MSG_TYPE.BROWSER_CLICKED,event:MSG_TYPE.GRID_DETECT})};var f=[];var r=function(s){chrome.tabs.query({active:true,currentWindow:true},function(t){var u=t[0];try{f[u.id].cancel()}catch(v){}if(!s){baidu.feNotification.notifyText({message:"对不起，检测失败"})}else{if(window.webkitNotifications&&webkitNotifications.createHTMLNotification){baidu.feNotification.notifyHtml("template/fehelper_wpo.html?"+JSON.stringify(s))}else{chrome.tabs.create({url:"template/fehelper_wpo.html?"+JSON.stringify(s),active:true})}}})};var l=function(){chrome.tabs.query({active:true,currentWindow:true},function(s){var t=s[0];f[t.id]=baidu.feNotification.notifyText({message:"正在统计，请稍后...",autoClose:false});chrome.tabs.sendMessage(t.id,{type:MSG_TYPE.GET_PAGE_WPO_INFO})})};var j=function(){chrome.tabs.query({active:true,currentWindow:true},function(s){var t=s[0];chrome.tabs.executeScript(t.id,{code:"void function(t,r,a,c,k){t.tracker_type='bm';t.tracker_uid='fehelper';(k=t.TrackerGlobalEvent)?k.f(r):[(k=t[a]('script')).charset='utf-8',k.src='http://www.ucren.com/'+c+'/'+c+'.js?'+Math.random(),t.documentElement.appendChild(k)]}(document,'TrackerJSLoad','createElement','tracker') ",allFrames:false,runAt:"document_end"})})};var d=function(){var s="http://www.baidufe.com/fehelper/codecompress.html";chrome.tabs.query({windowId:chrome.windows.WINDOW_ID_CURRENT},function(w){var y=false;var u;var x=new RegExp("fehelper.*codecompress.html$","i");for(var v=0,t=w.length;v<t;v++){if(x.test(w[v].url)){y=true;u=w[v].id;break}}if(!y){chrome.tabs.create({url:s,active:true})}else{chrome.tabs.update(u,{highlighted:true})}})};var m=function(s,t){return function(u){if(t){chrome.tabs.sendMessage(u.id,{type:MSG_TYPE.TAB_CREATED_OR_UPDATED,content:t,event:s})}}};var o=function(u,t,s){chrome.tabs.query({windowId:chrome.windows.WINDOW_ID_CURRENT},function(y){var A=false;var w;var z=new RegExp("^chrome.*"+t+".html$","i");for(var x=0,v=y.length;x<v;x++){if(z.test(y[x].url)){A=true;w=y[x].id;break}}if(!A){chrome.tabs.create({url:"template/fehelper_"+t+".html",active:true},m(t,s))}else{chrome.tabs.update(w,{highlighted:true},m(t,s))}})};var a=function(s){chrome.tabs.query({active:true,currentWindow:true},function(t){var u=t[0];if(s.useFile=="1"){o(u,s.msgType)}else{switch(s.msgType){case MSG_TYPE.FCP_HELPER_DETECT:g(u);break;case MSG_TYPE.GRID_DETECT:n(u);break;case MSG_TYPE.SHOW_PAGE_LOAD_TIME:l();break;case MSG_TYPE.JS_TRACKER:j();break;case MSG_TYPE.CODE_COMPRESS:d();break}}})};var c=function(){k();baidu.contextMenuId=chrome.contextMenus.create({title:"FeHelper",contexts:["page","selection","editable","link"],documentUrlPatterns:["http://*/*","https://*/*"]});chrome.contextMenus.create({title:"JSON格式化",contexts:["page","selection","editable"],parentId:baidu.contextMenuId,onclick:function(t,s){chrome.tabs.executeScript(s.id,{code:"("+(function(){return window.getSelection().toString()}).toString()+")()",allFrames:false},function(u){o(s,"jsonformat",u)})}});chrome.contextMenus.create({type:"separator",contexts:["all"],parentId:baidu.contextMenuId});chrome.contextMenus.create({title:"字符串编解码",contexts:["page","selection","editable"],parentId:baidu.contextMenuId,onclick:function(t,s){chrome.tabs.executeScript(s.id,{code:"("+(function(){return window.getSelection().toString()}).toString()+")()",allFrames:false},function(u){o(s,"endecode",u)})}});chrome.contextMenus.create({type:"separator",contexts:["all"],parentId:baidu.contextMenuId});chrome.contextMenus.create({title:"生成二维码",contexts:["page","selection","editable","link"],parentId:baidu.contextMenuId,onclick:function(t,s){chrome.tabs.executeScript(s.id,{code:"("+(function(){return window.getSelection().toString()||location.href}).toString()+")()",allFrames:false},function(u){o(s,"qrcode",u)})}});chrome.contextMenus.create({type:"separator",contexts:["all"],parentId:baidu.contextMenuId});chrome.contextMenus.create({title:"代码格式化",contexts:["page","selection","editable"],parentId:baidu.contextMenuId,onclick:function(t,s){chrome.tabs.executeScript(s.id,{code:"("+(function(){return window.getSelection().toString()}).toString()+")()",allFrames:false},function(u){o(s,"codebeautify",u)})}});chrome.contextMenus.create({type:"separator",contexts:["all"],parentId:baidu.contextMenuId});chrome.contextMenus.create({title:"代码压缩",contexts:["page","selection","editable"],parentId:baidu.contextMenuId,onclick:function(t,s){d()}})};var k=function(){if(!baidu.contextMenuId){return}chrome.contextMenus.remove(baidu.contextMenuId);baidu.contextMenuId=null};var e=function(){if(baidu.feOption.getOptionItem("opt_item_contextMenus")!=="false"){c()}else{k()}};var p=function(){chrome.runtime.onMessage.addListener(function(t,s,u){if(t.type==MSG_TYPE.GET_CSS){baidu.network.readFileContent(t.link,u)}else{if(t.type==MSG_TYPE.GET_JS){baidu.network.readFileContent(t.link,u)}else{if(t.type==MSG_TYPE.GET_HTML){baidu.network.readFileContent(t.link,u)}else{if(t.type==MSG_TYPE.GET_COOKIE){baidu.network.getCookies(t,u)}else{if(t.type==MSG_TYPE.REMOVE_COOKIE){baidu.network.removeCookie(t,u)}else{if(t.type==MSG_TYPE.SET_COOKIE){baidu.network.setCookie(t,u)}else{if(t.type==MSG_TYPE.CSS_READY){q.css=true}else{if(t.type==MSG_TYPE.JS_READY){q.js=true}else{if(t.type==MSG_TYPE.HTML_READY){q.html=true}else{if(t.type==MSG_TYPE.GET_OPTIONS){baidu.feOption.doGetOptions(t.items,u)}else{if(t.type==MSG_TYPE.SET_OPTIONS){baidu.feOption.doSetOptions(t.items,u);e()}else{if(t.type==MSG_TYPE.CALC_PAGE_LOAD_TIME){r(t.wpo)}else{if(t.type==MSG_TYPE.FROM_POPUP){a(t.config)}}}}}}}}}}}}}return true})};var i=function(){p();h();e()};return{init:i,runHelper:a}})();BgPageInstance.init();